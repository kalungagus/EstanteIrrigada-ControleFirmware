//***********************************************************************************************************************
//                                         Módulo de Timers
//***********************************************************************************************************************
#include "../Configuration/HardwareConfiguration.h"
#include "IOPorts.h"
#include <xc.h>

//***********************************************************************************************************************
// Variáveis privadas do módulo
//***********************************************************************************************************************
volatile uint32_t timer1Interrupts;

//***********************************************************************************************************************
// Interrupções
//***********************************************************************************************************************
//=======================================================================================================================
// Interrupção do timer 1
// Descrição: Sincronização de tempo das várias funções internas.
//=======================================================================================================================
void _ISR __attribute__((no_auto_psv)) _T1Interrupt(void)
{
    timer1Interrupts++;
    _T1IF = 0;
}

//***********************************************************************************************************************
// Funções públicas
//***********************************************************************************************************************
//=======================================================================================================================
// Liga ou desliga a contagem do timer
//=======================================================================================================================
void setTimerState(uint8_t state)
{
    T1CONbits.TON = state;
}

//=======================================================================================================================
// Verifica se o timer está ligado ou desligado
//=======================================================================================================================
uint8_t getTimerState(void)
{
    return(T1CONbits.TON);
}

//=======================================================================================================================
// Lê o marcador de tempo do timer. Retorno em milissegundos.
//=======================================================================================================================
uint32_t getTimerInterruptCount(void)
{
    uint32_t value;
    uint8_t timerStatus;
    
    timerStatus = _T1IE;
    _T1IE = 0;
    value = timer1Interrupts;
    _T1IE = timerStatus;
    return(value);
}

//=======================================================================================================================
// Inicialização de Timers
//=======================================================================================================================
void initTimers(void)
{
    T1CON = 0x0000;
    TMR1 = 0x0000;
    PR1 = 0x07D0;       // Valor para contagem de 1ms
    T1CON = 0x8010;     // Timer 1 On, Prescaler 1:8, clock interno = 500ns de período para 32MHz
    _T1IE = 1;          // Habilita interrupção do Timer 1
    _T1IP = 0x001;      // Prioridade mais baixa para a interrupção do Timer 1
    
    timer1Interrupts = 0;
}

//***********************************************************************************************************************